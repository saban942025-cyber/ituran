<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>爪专  驻注转 爪 - .住</title>
    <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: #0f172a; color: white; }
        .container { background: #1e293b; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #334155; }
        h1 { color: #38bdf8; text-align: center; margin-bottom: 30px; }
        /* 爪注 驻 住 专注 */
        .vis-item.PTO_OPEN { background-color: #22c55e; color: white; border-color: #16a34a; } /* 祝/PTO */
        .vis-item.IDLE { background-color: #ef4444; color: white; border-color: #dc2626; }    /* 住专拽 */
        .vis-item.OFF_HOURS { background-color: #eab308; color: white; border-color: #ca8a04; } /* 砖注转 专转 */
        .vis-panel.vis-left, .vis-label { color: white !important; background: #1e293b !important; border-color: #334155 !important; }
        .vis-time-axis .vis-text { color: #94a3b8 !important; }
    </style>
</head>
<body>
    <div class="container">
        <h1> 转 驻注转   转</h1>
        <div id="visualization"></div>
    </div>
<script>
    // 1. 专转 专 - 砖转砖 砖转 砖转 砖 转砖
    const SB_URL = 'https://dmdqfjivkmxrudwzwnao.supabase.co';
    const SB_KEY = 'sb_publishable_IbPB09lRqMLdSsoqb4bE4A_3e-98erS'; // 砖  转 驻转 专

    // 爪专转 拽 - 砖  砖 砖转砖 -global supabase 住驻专 砖住驻 -head
    //  住驻专 专 砖转 砖 'supabase', 砖转砖 砖 专 注专 -client 砖
    const supabaseClient = supabase.createClient(SB_URL, SB_KEY);

    async function loadTimeline() {
        try {
            console.log("转 砖 转 -Supabase...");
            
            // 2. 砖转 转  fleet_events
            const { data, error } = await supabaseClient
                .from('fleet_events')
                .select('*')
                .order('event_timestamp', { ascending: true });

            if (error) throw error;
            if (!data || data.length === 0) {
                console.warn(" 爪 转 ");
                return;
            }

            const items = new vis.DataSet();
            const groups = new vis.DataSet();
            const driverMap = new Map();
            let groupIdCounter = 1;

            // 3. 注 转 爪专 
            data.forEach((event, index) => {
                if (!driverMap.has(event.driver_name)) {
                    driverMap.set(event.driver_name, groupIdCounter);
                    groups.add({ id: groupIdCounter, content: event.driver_name });
                    groupIdCounter++;
                }

                const driverGroupId = driverMap.get(event.driver_name);
                const startTime = new Date(event.event_timestamp);
                // 专转 住 驻拽 转 转爪 (15 拽转)
                const endTime = new Date(startTime.getTime() + 15 * 60000); 

                items.add({
                    id: event.id || `evt-${index}`,
                    group: driverGroupId,
                    start: startTime,
                    end: endTime,
                    content: event.event_type ? event.event_type.replace('_', ' ') : '专注',
                    className: event.event_type,
                    title: `拽: ${event.location || ' 注'}`
                });
            });

            // 4. 专转 转爪
            const container = document.getElementById('visualization');
            const options = {
                stack: true,
                orientation: 'top',
                rtl: true,
                margin: { item: 10, axis: 5 }
            };

            new vis.Timeline(container, items, groups, options);
            console.log("爪专  注 爪!");

        } catch (err) {
            console.error("砖 拽专转:", err);
            document.getElementById('visualization').innerHTML = 
                `<div style="color: #ef4444; padding: 20px; text-align: center; border: 1px solid red; border-radius: 10px;">
                    砖 注转 转: ${err.message}<br>
                     砖专转 转 驻转 专 (Anon Key)  拽.
                </div>`;
        }
    }

    // 驻注
    loadTimeline();
</script>
</body>
</html>
