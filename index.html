<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ניהול צי איתורן - ניתוח נהגים</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --blue: #0056b3; --light: #e6f0ff; --success: #28a745; --danger: #dc3545; }
        body { font-family: sans-serif; background: #f4f7f6; margin: 0; padding: 20px; }
        .card { background: white; border-radius: 10px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .upload-zone { border: 2px dashed var(--blue); text-align: center; padding: 30px; cursor: pointer; }
        .driver-buttons { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
        .driver-btn { padding: 10px 20px; border: 1px solid var(--blue); background: white; color: var(--blue); border-radius: 5px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .driver-btn.active { background: var(--blue); color: white; }
        .vis-item.מנוף { background-color: var(--success); color: white; }
        .vis-item.נסיעה { background-color: #007bff; color: white; }
        .vis-item.סרק { background-color: var(--danger); color: white; }
        header { background: var(--blue); color: white; padding: 15px; border-radius: 10px 10px 0 0; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

<div class="card" style="padding:0;">
    <header>
        <span><i class="fas fa-truck-moving"></i> מערכת ניתוח נהגים - איתורן</span>
        <span id="file-name">ממתין לקובץ...</span>
    </header>
    <div class="upload-zone" onclick="document.getElementById('fileInput').click()">
        <i class="fas fa-file-excel" style="font-size: 40px; color: var(--blue);"></i>
        <p>לחץ כאן להעלאת דוח איתורן (CSV)</p>
        <input type="file" id="fileInput" accept=".csv" style="display: none">
    </div>
</div>

<div id="driver-selector" class="driver-buttons"></div>

<div class="card" id="analysis-card" style="display:none;">
    <h2 id="selected-driver-name">בחר נהג לצפייה</h2>
    <div id="timeline"></div>
    <div id="stats" style="margin-top:20px; display: flex; gap: 40px;">
        <div><strong>שעות מנוף:</strong> <span id="stat-pto">0</span></div>
        <div><strong>שעות נסיעה:</strong> <span id="stat-drive">0</span></div>
        <div><strong>שעות סרק:</strong> <span id="stat-idle">0</span></div>
    </div>
</div>

<script>
    let fleetData = {};
    let timeline = null;

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        document.getElementById('file-name').innerText = file.name;
        
        const reader = new FileReader();
        reader.onload = function(event) {
            parseCSV(event.target.result);
        };
        reader.readAsText(file);
    });

    function parseCSV(text) {
        const lines = text.split('\n');
        fleetData = {};
        
        // ניתוח שורות הדוח (החל משורה 8)
        for (let i = 7; i < lines.length; i++) {
            const cols = lines[i].split(',');
            if (cols.length < 10) continue;

            const time = cols[0];      // זמן הודעה
            const driver = cols[1];    // תג זיהוי
            const addr = cols[6];      // כתובת
            const status = cols[8] ? cols[8].replace(/\./g, '') : ""; // סטטוס נקי

            if (!driver || driver === "-" || driver === "תג זיהוי") continue;

            if (!fleetData[driver]) {
                fleetData[driver] = { timeline: [], stats: { pto: 0, drive: 0, idle: 0 } };
            }

            if (status.includes('PTO') || status.includes('תנועה') || status.includes('מונע')) {
                fleetData[driver].timeline.push({
                    start: moment(time, "DD/MM/YYYY HH:mm:ss").toDate(),
                    content: status,
                    className: status.includes('PTO') ? 'מנוף' : status.includes('תנועה') ? 'נסיעה' : 'סרק',
                    title: addr
                });
            }
        }
        renderDriverButtons();
    }

    function renderDriverButtons() {
        const container = document.getElementById('driver-selector');
        container.innerHTML = '';
        Object.keys(fleetData).forEach(driver => {
            const btn = document.createElement('button');
            btn.className = 'driver-btn';
            btn.innerText = driver;
            btn.onclick = () => showDriverData(driver, btn);
            container.appendChild(btn);
        });
    }

    function showDriverData(driver, btn) {
        // עיצוב כפתורים
        document.querySelectorAll('.driver-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        document.getElementById('analysis-card').style.display = 'block';
        document.getElementById('selected-driver-name').innerText = `ניתוח פעילות: ${driver}`;

        const container = document.getElementById('timeline');
        container.innerHTML = '';
        
        const items = new vis.DataSet(fleetData[driver].timeline);
        const options = { rtl: true, stack: true, orientation: 'top' };
        
        if (timeline) timeline.destroy();
        timeline = new vis.Timeline(container, items, options);

        // עדכון סיכומים (דוגמה לחישוב אירועים)
        const ptoEvents = fleetData[driver].timeline.filter(e => e.className === 'מנוף').length;
        document.getElementById('stat-pto').innerText = `${ptoEvents} אירועי הפעלה`;
    }
</script>

</body>
</html>
