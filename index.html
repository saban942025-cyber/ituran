<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>爪专  驻注转 爪 - .住</title>
    <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: #0f172a; color: white; }
        .container { background: #1e293b; padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid #334155; }
        h1 { color: #38bdf8; text-align: center; margin-bottom: 30px; }
        /* 爪注 驻 住 专注 */
        .vis-item.PTO_OPEN { background-color: #22c55e; color: white; border-color: #16a34a; } /* 祝/PTO */
        .vis-item.IDLE { background-color: #ef4444; color: white; border-color: #dc2626; }    /* 住专拽 */
        .vis-item.OFF_HOURS { background-color: #eab308; color: white; border-color: #ca8a04; } /* 砖注转 专转 */
        .vis-panel.vis-left, .vis-label { color: white !important; background: #1e293b !important; border-color: #334155 !important; }
        .vis-time-axis .vis-text { color: #94a3b8 !important; }
    </style>
</head>
<body>
    <div class="container">
        <h1> 转 驻注转   转</h1>
        <div id="visualization"></div>
    </div>

    <script>
        // 1. 专转 专 (驻转转 砖专转 -Vercel)
        const SUPABASE_URL = 'https://dmdqfjivkmxrudwzwnao.supabase.co';
        // 注专: 砖砖 -HTML 驻砖, 驻转 爪专 转 砖. -Next.js  注专 专 process.env
        const SUPABASE_KEY = 'sb_publishable_IbPB09lRqMLdSsoqb4bE4A_3e-98erS'; 

        const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        async function loadTimeline() {
            try {
                // 2. 砖转 转  fleet_events -Supabase
                const { data, error } = await supabase
                    .from('fleet_events')
                    .select('*')
                    .order('event_timestamp', { ascending: true });

                if (error) throw error;

                const items = new vis.DataSet();
                const groups = new vis.DataSet();
                const driverMap = new Map();
                
                let groupIdCounter = 1;

                // 3. 注 转 爪专 
                data.forEach((event, index) => {
                    // 爪专转 拽爪      拽转
                    if (!driverMap.has(event.driver_name)) {
                        driverMap.set(event.driver_name, groupIdCounter);
                        groups.add({ id: groupIdCounter, content: event.driver_name });
                        groupIdCounter++;
                    }

                    const driverGroupId = driverMap.get(event.driver_name);

                    // 住驻转 专注 爪专 
                    // 注专:  砖  专拽 拽转 , 专 砖  驻拽 砖 15 拽转 爪 转
                    const startTime = new Date(event.event_timestamp);
                    const endTime = new Date(startTime.getTime() + 15 * 60000); 

                    items.add({
                        id: event.id || index,
                        group: driverGroupId,
                        start: startTime,
                        end: endTime,
                        content: event.event_type.replace('_', ' '),
                        className: event.event_type,
                        title: `拽: ${event.location || ' 注'}`
                    });
                });

                // 4. 专转 转爪 砖 vis-timeline
                const container = document.getElementById('visualization');
                const options = {
                    stack: true,
                    orientation: 'top',
                    rtl: true,
                    margin: { item: 10, axis: 5 },
                    colors: { border: '#334155' }
                };

                new vis.Timeline(container, items, groups, options);

            } catch (err) {
                console.error("砖 注转 转:", err);
                document.getElementById('visualization').innerHTML = 
                    `<p style="color: #ef4444; text-align: center;">砖 专 专: ${err.message}</p>`;
            }
        }

        loadTimeline();
    </script>
</body>
</html>
