<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>מערכת ניתוח נהגים - איתורן</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script src="https://unpkg.com/vis-timeline@latest/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <link href="https://unpkg.com/vis-timeline@latest/styles/vis-timeline-graph2d.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --ituran-blue: #0056b3; --success: #28a745; --danger: #dc3545; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 20px; }
        .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .upload-area { border: 2px dashed var(--ituran-blue); text-align: center; padding: 40px; cursor: pointer; transition: 0.3s; }
        .upload-area:hover { background: #eef4ff; }
        .driver-btn { padding: 12px 24px; border: 2px solid var(--ituran-blue); background: white; color: var(--ituran-blue); border-radius: 25px; cursor: pointer; font-weight: bold; transition: 0.2s; margin: 5px; }
        .driver-btn.active { background: var(--ituran-blue); color: white; }
        header { background: var(--ituran-blue); color: white; padding: 15px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; }
        #timeline-container { height: 400px; margin-top: 20px; }
        .vis-item.מנוף { background-color: var(--success); border-color: #1e7e34; color: white; }
        .vis-item.נסיעה { background-color: #007bff; border-color: #0056b3; color: white; }
        .vis-item.סרק { background-color: var(--danger); border-color: #bd2130; color: white; }
    </style>
</head>
<body>

<div class="card" style="padding:0;">
    <header>
        <span><i class="fas fa-satellite"></i> ניתוח דוחות איתורן - ח.סבן</span>
        <span id="status-text">ממתין להעלאת CSV</span>
    </header>
    <div class="upload-area" onclick="document.getElementById('csvInput').click()">
        <i class="fas fa-file-csv" style="font-size: 50px; color: var(--ituran-blue); margin-bottom: 15px;"></i>
        <h3>גרור דוח איתורן לכאן או לחץ לבחירה</h3>
        <input type="file" id="csvInput" accept=".csv" style="display: none;">
    </div>
</div>

<div id="driver-list" class="card" style="display:none; text-align:center;">
    <h3>בחר נהג לניתוח פעילות:</h3>
    <div id="buttons-container"></div>
</div>

<div id="analysis-section" class="card" style="display:none;">
    <h2 id="current-driver-title" style="color: var(--ituran-blue);"></h2>
    <div id="timeline-container"></div>
</div>
<script>
    function processData(text) {
        const lines = text.split('\n');
        fleetData = {};
        
        for (let i = 7; i < lines.length; i++) {
            // טיפול חכם בשורות עם פסיקים בתוך גרשיים (כתובות)
            const cols = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if (!cols || cols.length < 9) continue;

            const timeStr = cols[0].replace(/"/g, '').trim();
            const driverName = cols[1].replace(/"/g, '').trim(); 
            const address = cols[6] ? cols[6].replace(/"/g, '').trim() : "";
            const status = cols[8] ? cols[8].replace(/"/g, '').replace(/\./g, '').trim() : "";

            if (!driverName || driverName === "תג זיהוי" || driverName === "-") continue;

            if (!fleetData[driverName]) {
                fleetData[driverName] = [];
            }

            // חיפוש מילות מפתח בסטטוס
            const isPTO = status.includes('PTO') || status.includes('מנוף');
            const isDrive = status.includes('תנועה') || (status.includes('מונע') && !status.includes('עומד'));
            const isIdle = status.includes('עומד מונע') || status.includes('סרק');

            if (isPTO || isDrive || isIdle) {
                fleetData[driverName].push({
                    start: moment(timeStr, "DD/MM/YYYY HH:mm:ss").toDate(),
                    content: status,
                    className: isPTO ? 'מנוף' : isDrive ? 'נסיעה' : 'סרק',
                    title: `מיקום: ${address}`
                });
            }
        }
        
        if (Object.keys(fleetData).length === 0) {
            alert("הקובץ נקרא אבל לא נמצאו אירועי פעילות (PTO/נסיעה). בדוק את תוכן הקובץ.");
        }
        
        showDriverSelection();
    }

    function renderTimeline(driver, btn) {
        document.querySelectorAll('.driver-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');

        document.getElementById('analysis-section').style.display = 'block';
        document.getElementById('current-driver-title').innerText = `דוח פעילות מפורט: ${driver}`;

        const container = document.getElementById('timeline-container');
        container.innerHTML = '';

        // מיון הנתונים לפי זמן כדי למנוע קפיצות בגרף
        const sortedData = fleetData[driver].sort((a, b) => a.start - b.start);
        
        const items = new vis.DataSet(sortedData);
        const options = {
            rtl: true,
            stack: false, // שינוי ל-false כדי לראות אירועים חופפים (כמו מנוף בזמן שהמנוע דולק)
            orientation: 'top',
            margin: { item: 10 },
            showCurrentTime: false
        };

        if (activeTimeline) activeTimeline.destroy();
        activeTimeline = new vis.Timeline(container, items, options);
    }
</script>

</body>
</html>
