<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>Saban Ituran App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        :root { --blue: #0056b3; --danger: #ff4d4d; --success: #28a745; }
        body { font-family: system-ui, -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding-bottom: 80px; }
        .header { background: var(--blue); color: white; padding: 20px; text-align: center; font-weight: bold; font-size: 20px; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .upload-card { background: white; margin: 15px; padding: 20px; border-radius: 15px; border: 2px dashed var(--blue); text-align: center; }
        .driver-card { background: white; margin: 10px; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-right: 5px solid #ccc; }
        .driver-card.has-pto { border-right-color: var(--success); }
        .driver-card.has-idle { border-right-color: var(--danger); }
        .info { display: flex; flex-direction: column; gap: 5px; }
        .name { font-weight: bold; font-size: 18px; color: var(--blue); }
        .stats { font-size: 14px; color: #666; }
        .badge { padding: 4px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; color: white; }
        .badge-pto { background: var(--success); }
        .badge-idle { background: var(--danger); }
        .nav-bar { position: fixed; bottom: 0; width: 100%; background: white; display: flex; justify-content: space-around; padding: 15px 0; border-top: 1px solid #ddd; }
    </style>
</head>
<body>

<div class="header">爪 专 .住 -  转</div>

<div class="upload-card">
    <label for="csv-file" style="cursor: pointer;">
        <i style="font-size: 30px;"></i><br>
        <strong>抓 注转   (CSV)</strong>
    </label>
    <input type="file" id="csv-file" accept=".csv" style="display: none;">
</div>

<div id="app-content">
    <div style="text-align: center; color: #999; margin-top: 50px;">转 转...</div>
</div>

<div class="nav-bar">
    <span>  </span>
    <span> </span>
    <span>锔 专转</span>
</div>

<script>
    document.getElementById('csv-file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            // 驻注 注专转 (Windows-1255)
            const decoder = new TextDecoder('windows-1255');
            const text = decoder.decode(event.target.result);
            processData(text);
        };
        reader.readAsArrayBuffer(file);
    });

    function processData(csvText) {
        const lines = csvText.split('\n');
        const summary = {};

        //  住专拽  转 砖专
        for (let i = 7; i < lines.length; i++) {
            // Regex 砖驻 驻住拽 转 转转 (专砖)
            const cols = lines[i].match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if (!cols || cols.length < 9) continue;

            const name = cols[1].replace(/"/g, '').trim();
            const status = cols[8] ? cols[8].replace(/"/g, '').trim() : "";
            
            if (!name || name === "转 " || name === "-") continue;

            if (!summary[name]) summary[name] = { pto: 0, idle: 0, lastAddr: "" };

            //   住住
            if (status.includes('PTO')) summary[name].pto++;
            if (status.includes('注 注')) summary[name].idle++;
            summary[name].lastAddr = cols[6].replace(/"/g, '');
        }

        renderApp(summary);
    }

    function renderApp(data) {
        const container = document.getElementById('app-content');
        container.innerHTML = "";

        Object.keys(data).forEach(name => {
            const d = data[name];
            const ptoClass = d.pto > 0 ? 'has-pto' : '';
            const idleClass = d.idle > 0 ? 'has-idle' : '';
            
            container.innerHTML += `
                <div class="driver-card ${ptoClass} ${idleClass}">
                    <div class="info">
                        <span class="name">${name}</span>
                        <span class="stats"> ${d.lastAddr.split(',')[0]}</span>
                    </div>
                    <div style="display: flex; gap: 5px;">
                        ${d.pto > 0 ? `<span class="badge badge-pto">祝: ${d.pto}</span>` : ''}
                        ${d.idle > 0 ? `<span class="badge badge-idle">住专拽!</span>` : ''}
                    </div>
                </div>
            `;
        });
    }
</script>
</body>
</html>
