<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>Saban Elite Fleet</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --main: #0046ad; --success: #2ecc71; --warn: #f1c40f; --danger: #e74c3c; --bg: #fdfdfd; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; color: #333; }
        
        /* המבורגר יוקרתי */
        header { background: #fff; padding: 15px 25px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid #eee; position: sticky; top: 0; z-index: 1000; }
        .menu-btn { font-size: 22px; color: var(--main); cursor: pointer; }
        .brand { font-weight: 900; color: var(--main); font-size: 1.3rem; }

        /* כרטיסי נהגים - עיצוב שער */
        .dashboard { padding: 20px; display: grid; gap: 20px; }
        .driver-gate { background: #fff; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05); border: 1px solid #f0f0f0; display: flex; flex-direction: column; position: relative; }
        .driver-header { display: flex; align-items: center; margin-bottom: 15px; }
        .p-img { width: 65px; height: 65px; border-radius: 50%; object-fit: cover; border: 3px solid #eef2f7; margin-left: 15px; }
        
        /* ניתוח המוח */
        .brain-alert { background: #f8faff; border-right: 4px solid var(--main); padding: 12px; border-radius: 8px; font-size: 0.9rem; margin-top: 10px; }
        .stat-row { display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.85rem; border-top: 1px solid #f9f9f9; padding-top: 8px; }
        
        /* שדות ניהול דינמיים */
        .settings-card { background: #fff; margin: 20px; border-radius: 15px; padding: 20px; border: 1px solid #eee; }
        .input-box { display: flex; gap: 10px; margin-top: 10px; }
        input { flex: 1; padding: 12px; border: 1.5px solid #eee; border-radius: 10px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--main); }

        .speed-bad { color: var(--danger); font-weight: bold; }
        .profit-good { color: var(--success); font-weight: bold; }
    </style>
</head>
<body>

<header>
    <div class="menu-btn"><i class="fas fa-bars"></i></div>
    <div class="brand">ח.סבן - מרכז פיקוד</div>
    <div style="width:20px;"></div>
</header>

<div class="settings-card">
    <h3 style="margin:0;"><i class="fas fa-calculator"></i> פרמטרים לחישוב רווחיות</h3>
    <div class="input-box">
        <input type="number" id="fuel" value="7.25" placeholder="מחיר סולר">
        <input type="number" id="hourly" value="500" placeholder="תעריף שעה">
    </div>
</div>

<div class="dashboard" id="mainDash">
    <div style="text-align: center; color: #bbb; padding: 40px;">העלה דוח אקסל מלא מאיתורן להתחלת הניתוח...</div>
</div>

<div style="position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%;">
    <button onclick="document.getElementById('f').click()" style="width:100%; padding:18px; border-radius:15px; border:none; background:var(--main); color:#fff; font-weight:bold; box-shadow: 0 10px 20px rgba(0,70,173,0.3);">
        <i class="fas fa-file-excel"></i> טען דוח נתונים מלא
    </button>
    <input type="file" id="f" style="display:none" accept=".csv, .xlsx">
</div>

<script>
    // הגדרת פרופילים ותמונות
    const driverProfiles = {
        'חכמת': { img: 'https://ibb.co/S76BMYt0', type: 'מנוף' },
        'בורהאן': { img: 'https://i.ibb.co/S76BMYt0/burhan.jpg', type: 'רמסה' },
        'יואב': { img: 'https://i.ibb.co/S76BMYt0/yoav.jpg', type: 'איסוזו' }
    };

    document.getElementById('f').addEventListener('change', function(e) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const decoder = new TextDecoder('windows-1255');
            processFullReport(decoder.decode(ev.target.result));
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    });

    function processFullReport(data) {
        const lines = data.split('\n');
        const analysis = {};
        
        lines.forEach((line, idx) => {
            if(idx < 7) return;
            const cols = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
            if(!cols || cols.length < 15) return;

            const name = cols[1].replace(/"/g, '').trim();
            const status = cols[8] ? cols[8].replace(/"/g, '') : "";
            const speed = parseInt(cols[7]) || 0;
            const limit = parseInt(cols[23]) || 90; // נניח עמודה 23 למהירות מותרת
            const durationStr = cols[28] || "00:00:00"; // משך זמן בפורמט שעות

            if(!analysis[name]) analysis[name] = { ptoTime: 0, speedViolations: 0, totalWork: 0, lastAddr: cols[6] };

            if(status.includes('PTO')) analysis[name].ptoTime += 0.5; // חישוב משוער לכל רשומה
            if(speed > limit) analysis[name].speedViolations++;
        });

        renderElite(analysis);
    }

    function renderElite(data) {
        const dash = document.getElementById('mainDash');
        dash.innerHTML = '';
        
        Object.keys(data).forEach(name => {
            if(name.includes('תג') || name === "-") return;
            const p = driverProfiles[name] || { img: '', type: 'משאית' };
            const diesel = document.getElementById('fuel').value;
            const rate = document.getElementById('hourly').value;
            
            // המוח מנתח: רווחיות פריקה
            const revenue = (data[name].ptoTime * rate).toFixed(0);
            
            dash.innerHTML += `
                <div class="driver-gate">
                    <div class="driver-header">
                        <img src="${p.img}" class="p-img" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png'">
                        <div>
                            <div style="font-weight:bold; font-size:1.1rem;">${name}</div>
                            <div style="font-size:0.8rem; color:#888;">${p.type} | סביבת עבודה: ${data[name].lastAddr.split(',')[0]}</div>
                        </div>
                    </div>
                    <div class="brain-alert">
                        <i class="fas fa-lightbulb" style="color:var(--warn)"></i>
                        המוח: ${revenue > 0 ? `הכנסה משוערת מפעילות מנוף: <span class="profit-good">${revenue} ש"ח</span>` : 'לא זוהתה פעילות מנוף רווחית כרגע'}
                    </div>
                    <div class="stat-row">
                        <span>חריגות מהירות: <span class="${data[name].speedViolations > 0 ? 'speed-bad' : ''}">${data[name].speedViolations}</span></span>
                        <span>זמן פריקה מצטבר: ${data[name].ptoTime.toFixed(1)} שעות</span>
                    </div>
                </div>
            `;
        });
    }
</script>
</body>
</html>
