<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saban Elite - Fixed Encoding</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/encoding-japanese/2.0.0/encoding.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        :root { --primary: #0046ad; --light-bg: #f8fbff; }
        body { font-family: 'Segoe UI', system-ui; background: var(--light-bg); margin: 0; text-align: center; }
        .app-header { background: #fff; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); color: var(--primary); font-weight: 900; font-size: 1.4rem; }
        .upload-area { margin: 30px auto; width: 90%; max-width: 500px; padding: 40px; border: 3px dashed #cbd5e0; border-radius: 20px; background: #fff; cursor: pointer; }
        .driver-card { background: #fff; margin: 15px; padding: 20px; border-radius: 20px; shadow: 0 4px 15px rgba(0,0,0,0.05); display: flex; align-items: center; text-align: right; border-right: 6px solid var(--primary); }
        .status-msg { color: #718096; margin-top: 10px; font-size: 0.9rem; }
    </style>
</head>
<body>

<div class="app-header">.住 - 转拽 '专砖 </div>

<div class="upload-area" id="dropZone" onclick="document.getElementById('fileInput').click()">
    <i class="fas fa-file-import" style="font-size: 40px; color: var(--primary); mb: 15px;"></i>
    <h3>专专  转专 </h3>
    <p> 转拽 转 注专转  转  转</p>
    <input type="file" id="fileInput" style="display:none" accept=".csv">
</div>

<div id="driverGrid"></div>

<script>
    const fileInput = document.getElementById('fileInput');

    fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            // 1. 拽专转 转  
            const uint8Array = new Uint8Array(event.target.result);
            
            // 2.  拽 (Windows-1255  UTF-8)
            const detected = Encoding.detect(uint8Array);
            
            // 3. 专 -Unicode (注专转 拽)
            const unicodeArray = Encoding.convert(uint8Array, {
                to: 'UNICODE',
                from: detected,
                type: 'string'
            });

            // 4. 砖  转 
            parseCleanData(unicodeArray);
        };
        reader.readAsArrayBuffer(file);
    });

    function parseCleanData(csvString) {
        Papa.parse(csvString, {
            header: false,
            skipEmptyLines: true,
            complete: function(results) {
                const data = results.data;
                const stats = {};
                
                //  住专拽 转 转 注
                for(let i = 9; i < data.length; i++) {
                    const row = data[i];
                    if (row.length < 5) continue;

                    //   砖: 注 2   (转 )
                    const name = row[2] ? row[2].trim() : "";
                    const status = row[16] ? row[16].trim() : "";

                    if (!name || name === "转 " || name === "-") continue;

                    if (!stats[name]) stats[name] = { pto: 0, lastSeen: "" };
                    if (status.includes('PTO')) stats[name].pto++;
                    stats[name].lastSeen = row[13] || " 注";
                }
                renderDrivers(stats);
            }
        });
    }

    function renderDrivers(stats) {
        const grid = document.getElementById('driverGrid');
        grid.innerHTML = "";
        
        const drivers = Object.keys(stats);
        if (drivers.length === 0) {
            grid.innerHTML = "<p> 爪  .  砖注转  .</p>";
            return;
        }

        drivers.forEach(name => {
            grid.innerHTML += `
                <div class="driver-card">
                    <div style="flex-grow: 1;">
                        <strong style="font-size: 1.2rem; color: #2d3436;">${name}</strong><br>
                        <span style="font-size: 0.85rem; color: #718096;"> 拽 专: ${stats[name].lastSeen.split(',')[0]}</span>
                    </div>
                    <div style="text-align: left;">
                        <span style="background: #e3fcef; color: #00b894; padding: 5px 12px; border-radius: 15px; font-weight: bold; font-size: 0.8rem;">
                            ${stats[name].pto > 0 ? '注转 祝' : '驻注'}
                        </span>
                    </div>
                </div>
            `;
        });
    }
</script>

</body>
</html>
